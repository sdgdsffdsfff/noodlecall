var __extends=this.__extends||function(e,t){function n(){this.constructor=e}n.prototype=t.prototype,e.prototype=new n},wijmo;(function(e){(function(t){"use strict";function h(){return document.location.hash.match(/^#\w+=/)}var n=jQuery,r="wijappview",i={menu:"menu",content:"content",header:"header",footer:"footer",page:"appviewpage"},s={adjusted:r+"-adjusted"},o="",u=!1;n.fn.findRole=function(e){return this.find(":jqmData(role='"+e+"')")};var a=function(e){function t(){e.apply(this,arguments),this._updatingUrl=!1}return __extends(t,e),t.prototype._appViewCSS=function(){return this.options.wijCSS.wijappview},t.prototype._initMenu=function(){this._menuDiv=this.element.findRole(i.menu);if(!this._menuDiv.length)throw"A DIV with data-role='"+i.menu+"' not found!";this._linkList=this._menuDiv.find("ul");if(!this._linkList.length)throw"Invalid markup. Link list not found";this._menuDiv.addClass(this._appViewCSS().menu)},t.prototype._initPages=function(e,t){var r=this._pageStore,i=this._appViewCSS();e.each(function(){var e=n(this).addClass(i.page),r=e.attr("id"),s=t;if(e.jqmData("url"))return;r&&(s+="#"+r),e.attr("data-url",s)})},t.prototype._initPageContainer=function(){var e=this._appViewCSS(),t=this._pageStore;this._pageContainer=n("<div/>").addClass(e.pageContainer).prependTo(this.element);var r=this.element.findRole(i.page);this._initPages(r,this._documentUrl),r.each(function(e){t.push(n(this).clone()),e>0&&n(this).remove()}),this._firstPage=r.first().addClass(e.pageActive).appendTo(this._pageContainer),this._initCurrentPage()},t.prototype._getUrl=function(e){var t=e.is("form")?"action":"href",r=e.attr(t);return!r||r==="#"?null:(n.mobile.path.isRelativeUrl(r)&&e.parents(":jqmData(url)").each(function(e,t){var i=n(t).jqmData("url");if(i&&n.mobile.path.isAbsoluteUrl(i))return r=n.mobile.path.makeUrlAbsolute(r,i),!1}),r)},t.prototype._hijackLinks=function(e){var t=this;e.on("click."+r,"a, .ui-btn",function(e){if(e.isDefaultPrevented())return;var r=t._findClosestLink(e.target);if(!r||n(r).jqmData("appviewpage")===!1)return;var i=t._getUrl(n(r));i&&(e.preventDefault(),e.stopPropagation(),t.changePage(i))})},t.prototype._hijackForms=function(e){var t=this;e.on("submit."+r,"form",function(e){if(e.isDefaultPrevented())return;var r=n(e.currentTarget),i=r.closest("."+t._appViewCSS().page);if(!n.mobile.ajaxEnabled||r.is(":jqmData(ajax='false')")||!r.jqmHijackable().length)return;var s=r.attr("method"),o=r.attr("target"),u=t._getUrl(r);e.preventDefault(),e.stopPropagation(),t.changePage(u,{type:s&&s.length&&s.toLowerCase()||"get",data:r.serialize(),reloadPage:!0})})},t.prototype._initNavigation=function(){var e=this;this._onPopStateScoped=this._onPopStateScoped||n.proxy(this._onPopState,this),n(window).bind("popstate."+r,this._onPopStateScoped),n(window).bind("appviewpagehashchange."+r,function(){return e._navigateToCurrentLocation()}),this._onNavigateScoped=this._onNavigateScoped||n.proxy(this._onNavigate,this),n(n.mobile.pageContainer).bind("navigate."+r,this._onNavigateScoped)},t.prototype._create=function(){this._pageStore=[],this._documentUrl=this._removePageUrlParam(location.href),this.element.attr("data-url",this._documentUrl),this._jqmPageEnclosingWidget=this._findJqmPage(),this.element.addClass(this._appViewCSS().outerDiv),this._initMenu(),this._initPageContainer(),this._hijackLinks(this.element),this._hijackForms(this.element),this._initNavigation(),this._navigateToCurrentLocation()},t.prototype.destroy=function(){e.prototype.destroy.call(this);var t="."+r;this.element.unbind(t),n(window).unbind(t),n(n.mobile.pageContainer).unbind(t)},t.prototype._findJqmPage=function(){for(var e=this.element;e.length;e=e.parent()){var t=e.jqmData("mobile-page");if(t)return t}return null},t.prototype._initCurrentPage=function(){var e=this._appViewCSS(),t=this.activePage();t.findRole(i.content).addClass(e.content);var n=t.findRole(i.header).addClass(e.header),r=n.jqmData("position"),s=!r||r==="fixed";s&&n.addClass("ui-header-fixed"),this.element.toggleClass(e.withFixedHeader,s)},t.prototype._findClosestLink=function(e){while(e&&(typeof e.nodeName!="string"||e.nodeName.toLowerCase()!=="a"))e=e.parentNode;return e},t.prototype._clickHandler=function(e){var t=n(e.currentTarget),r=t.is("li")?t.jqmData("url"):t.is("a")?t.attr("href"):null;if(!r)return;e.preventDefault(),e.stopPropagation(),this.changePage(r)},t.prototype._inheritAttribute=function(e,t,n){e.attr(n)&&!t.attr(n)&&t.attr(n,e.attr(n))},t.prototype._findInCache=function(e){return n(n.grep(this._pageStore,function(t){return t.jqmData("url")===e})[0]).clone()},t.prototype.loadPage=function(e,t){var r=this;e=e||"";var s=n.Deferred(),o=n.mobile.path,u=n.extend({},this.options.loadSettings,t),a=!e||e.charAt(0)==="#",f=null,l=null,c=this._makeAbsoluteUrl(e);if(u.data)switch(u.type){case"get":c=o.addSearchParams(c,u.data),u.data=undefined;break;case"post":u.reloadPage=!0}var h=n.Event("pagebeforeload"),p={url:e,absUrl:c,dataUrl:c,deferred:s,options:u};this._trigger(h.type,h,p);if(h.isDefaultPrevented())return s.promise();if(!n.mobile.allowCrossDomainPages&&!o.isSameDomain(o.parseLocation(),c))return s.reject(c,t),s.promise();var d=c&&o.getFilePath(c).replace(/#.+/,""),v=n.ajax({url:d,type:u.type,data:u.data,dataType:"html",success:function(u,a,h){function y(e){return o.isAbsoluteUrl(e)||/^(\w+:|#|\/)/.test(e)?null:o.makeUrlAbsolute(e,d)}var v=n("<div></div>"),m=new RegExp("(<[^>]+\\bdata-"+n.mobile.ns+"role=[\"']?"+i.page+"[\"']?[^>]*>)"),g=new RegExp("\\bdata-"+n.mobile.ns+"url=[\"']?([^\"'>]*)[\"']?");n.browser.msie&&parseFloat(n.browser.version)<=7&&(u=u.replace(/<a[^>]+href=['"][^'"]+['"]/g,function(e){return e.replace(/href=['"]([^'"]+)['"]/,function(e,t){return t=y(t)||t,"href='"+t+"'"})})),v.get(0).innerHTML=u;var b=r._getAllPages(v,e);b.length||(b=n("<div/>").attr("data-role",i.page).html(u.split(/<\/?body[^>]*>/gmi)[1]));var w=u.match(/<title[^>]*>([^<]*)/)&&RegExp.$1;w&&~w.indexOf("&")&&(w=n("<div>"+w+"</div>").text()),b.each(function(e,t){t=n(t),t.attr("data-external-page",!0),!t.jqmData("title")&&w&&t.attr("data-title",w);var r=o.get(d);t.find("[src], [href]").each(function(){var e=n(this).is("[href]")?"href":n(this).is("[src]")?"src":"action",t=y(n(this).attr(e));t&&n(this).attr(e,t)})}),r._initPages(b,d),f=b.filter(function(){return n(this).jqmData("url")===c}),f.length||(f=b.first()),p.xhr=h,p.textStatus=a,p.page=f,p.allPages=b,r._trigger("pageload",null,p),b.each(function(e,t){r._pageStore.push(n(t).clone())}),s.resolve(c,t,f,l)},error:function(e,i,o){p.xhr=e,p.textStatus=i,p.errorThrown=o;var u=n.Event("pageloadfailed");r._trigger(u.type,u,p);if(u.isDefaultPrevented())return;s.reject(c,t)}});return s.fail(function(){v.abort()}),s},t.prototype._getAllPages=function(e,t){return e.findRole(i.page)},t.prototype.activePage=function(){return this._pageContainer.children("."+this._appViewCSS().pageActive).first()},t.prototype.isMenuUrl=function(e){var t=this;return e=e.toLowerCase(),this._menuDiv.find("a").is(function(){return t._getUrl(n(this)).toLowerCase()===e})},t.prototype._showLoading=function(){n.mobile.loading("show")},t.prototype._hideLoading=function(){n.mobile.loading("hide")},t.prototype.changePage=function(e,t){var r=this;t=n.extend({updateUrl:!0},this.options.loadSettings,t);var o={toPage:e,options:t};this._curRequest&&this._curRequest.state()==="pending"&&this._curRequest.rejectWith&&this._curRequest.rejectWith(this,[e,t,!0]);var a,f;if(typeof e=="string"){a=this.activePage().data("url"),f=this._makeAbsoluteUrl(e);var l=f.indexOf("#");if(l>=0&&f.substr(0,l)===a.split("#")[0]){var c=this._findInCache(f);c.length&&(e=c)}}if(typeof e=="string"){this._updateUIBeforeChange(f),t.showLoadMsg&&this._showLoading(),this._curRequest=this.loadPage(e,t).always(function(){t.showLoadMsg&&r._hideLoading(),r._curRequest=null}).done(function(e,t,n,i){r._updateUIAfterChange(n.jqmData("url")),r.changePage(n,t)}).fail(function(e,t,n){n||r._updateUI(a),r._trigger("pagechangefailed",null,o)});return}var h=n.Event("pagebeforechange");this._trigger(h.type,h,o);if(h.isDefaultPrevented())return;var p=e.jqmData("url"),d=null;this._updateUI(p),p&&(d=this._makeRelative(p),d!=null&&(d=this._makeRelative(d)));var v=e.jqmData("title"),m=e.findRole("header"),g=this._appViewCSS();!m.length&&v&&(m=n("<div data-role='header'/>").append(n("<h2/>").text(v)).prependTo(e));if(m.length&&!m.jqmData(s.adjusted)){m.jqmData(s.adjusted,!0);var y=this._firstPage.findRole(i.header);y&&this._inheritAttribute(y,m,"data-position"),this.isMenuUrl(p)&&!m.find("a[data-icon=back]").length&&n("<a/>").attr({href:this._documentUrl,"data-icon":"back"}).text("Back").prependTo(m)}v&&(document.title=v),this._pageContainer.children().removeClass(g.pageActive),e.addClass(g.pageActive).appendTo(this._pageContainer.empty()),this._initCurrentPage();if(t.updateUrl||u)this._updateUrl(p,d,document.title),u=!1;e.jqmData("page",this._jqmPageEnclosingWidget).trigger("pagecreate").trigger(this.widgetEventPrefix+"pageinit",o),this._trigger("pagechange",null,o)},t.prototype._updateUIBeforeChange=function(e){var t=this,r=e===this._documentUrl,i=this._linkList.find("li"),s=this._appViewCSS().menuItemActive;if(r)i.removeClass(s);else{var o=i.filter(function(){var r=t._getUrl(n(this).find("a"));return r&&r.toLowerCase()===e.toLowerCase()});o.length&&!o.hasClass(s)&&(i.removeClass(s),o.addClass(s))}},t.prototype._updateUIAfterChange=function(e){var t=this._appViewCSS(),n=e===this._documentUrl;this.element.toggleClass(t.inPage,!n)},t.prototype._updateUI=function(e){this._updateUIBeforeChange(e),this._updateUIAfterChange(e)},t.prototype._changePageIfDifferent=function(e,t){var n=typeof e=="string"?e:e.jqmData("url");this.activePage().jqmData("url")!==n&&this.changePage(e,t)},t.prototype._onNavigate=function(e){var t=new RegExp("^#?"+this.options.urlParamName+"=");(history.state&&history.state.wijappview||document.location.hash.match(t))&&e.preventDefault()},t.prototype._removePageUrlParam=function(e){return e.replace(/\#.*$/,"")},t.prototype._addUrl=function(e){var t=this.options.urlParamName,n=this._removePageUrlParam(location.href);return e&&(n+="#"+t+"="+e),n},t.prototype._makeRelative=function(e){var t=n.mobile.path.parseLocation(),r=e;if(e){var i=t.domain+t.directory;e.substr(0,t.hrefNoHash.length)===t.hrefNoHash?r=e.substr(t.hrefNoHash.length):e.substr(0,i.length)===i&&(r=e.substr(i.length))}return r},t.prototype._makeAbsoluteUrl=function(e){var t=n.mobile.path,r=this.activePage(),i=t.makeUrlAbsolute(r.jqmData("url")||this._documentUrl,this._documentUrl);return!i.match(/\/$/)&&!i.match(/\./)&&(i+="/"),e&&t.makeUrlAbsolute(e,i)},t.prototype._onPopState=function(e){if(this._updatingUrl)return;history.state&&history.state.wijappview?this._changePageIfDifferent(history.state.absUrl||this._firstPage,{updateUrl:!1}):this._navigateToCurrentLocation()},t.prototype._navigateToCurrentLocation=function(){var e=new RegExp("#"+this.options.urlParamName+"=(.+)"),t=e.exec(location.href)||o&&e.exec(o),r=t?n.mobile.path.makeUrlAbsolute(t[1],this._documentUrl):this._firstPage;o="",this._changePageIfDifferent(r,{updateUrl:!1})},t.prototype._updateUrl=function(e,t,r){this._updatingUrl=!0;try{n.mobile.urlHistory.ignoreNextHashChange=!0,document.location.hash=e===this._documentUrl?"":this.options.urlParamName+"="+t}finally{this._updatingUrl=!1}},t}(e.wijmoWidget);t.wijappview=a;var f="wijmo-wijappview",l=f+"-",c=function(){function e(){this.urlParamName="appviewpage",this.loadSettings={type:"GET",data:undefined,reloadPage:!1,showLoadMsg:!1},this.wijCSS={wijappview:{outerDiv:f,inPage:l+"in-page",menu:l+"menu",menuItemActive:"ui-btn-down-b",page:l+"page",pageActive:l+"page-active",pageContainer:l+"page-container",content:l+"content",header:l+"header",withFixedHeader:l+"with-fixed-header"}}}return e}();t.wijappview_options=c,a.prototype.options=n.extend({},e.wijmoWidget.prototype.options,new c),n.mobile&&(n.wijmo.registerWidget(r,a.prototype),n(window).bind("hashchange",function(e){h()&&(e.stopImmediatePropagation(),n(window).trigger("appviewpagehashchange"))}),h()&&(o=document.location.hash,n(window).bind("pagecontainercreate",function(){document.location.hash="",u=!0})))})(e.appview||(e.appview={}));var t=e.appview})(wijmo||(wijmo={}));